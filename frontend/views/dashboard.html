<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VigilaCore | Dashboard Inteligente</title>
    <link rel="stylesheet" href="../css/v2_modern.css">
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="../js/sidebar_toggle.js"></script>
    <script src="../js/utils.js"></script>
    <style>
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }
        .metric-card {
            background: var(--v2-surface);
            border: 1px solid var(--v2-border);
            border-radius: 12px;
            padding: 1.5rem;
            position: relative;
            overflow: hidden;
            transition: all 0.3s ease;
        }
        .metric-card:hover {
            transform: translateY(-2px);
            border-color: var(--v2-primary);
            box-shadow: 0 8px 16px rgba(0, 209, 255, 0.1);
        }
        .metric-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 3px;
            background: linear-gradient(90deg, var(--v2-primary), var(--v2-success));
        }
        .metric-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }
        .metric-title {
            font-size: 0.75rem;
            font-weight: 700;
            color: var(--v2-text-dim);
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        .metric-icon {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(0, 209, 255, 0.1);
            border: 1px solid rgba(0, 209, 255, 0.2);
        }
        .metric-value {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--v2-primary);
            margin-bottom: 0.5rem;
            line-height: 1;
        }
        .metric-label {
            font-size: 0.875rem;
            color: var(--v2-text-dim);
        }
        .chart-container {
            background: var(--v2-surface);
            border-radius: 12px;
            padding: 1.5rem;
            border: 1px solid var(--v2-border);
            margin-bottom: 1.5rem;
        }
        .chart-title {
            font-size: 1.125rem;
            font-weight: 700;
            color: var(--v2-text);
            margin-bottom: 0.25rem;
        }
        .chart-subtitle {
            font-size: 0.75rem;
            color: var(--v2-text-dim);
            margin-bottom: 1.5rem;
            letter-spacing: 0.3px;
        }
        .efficiency-score {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 2rem 1rem;
        }
        .score-circle {
            width: 180px;
            height: 180px;
            border-radius: 50%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            margin-bottom: 1rem;
            position: relative;
            background: var(--v2-bg);
            border: 3px solid var(--v2-border);
        }
        .score-value {
            font-size: 3rem;
            font-weight: 800;
            color: var(--v2-primary);
            line-height: 1;
        }
        .score-label {
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-top: 0.5rem;
            color: var(--v2-text-dim);
            font-weight: 700;
        }
        .score-classification {
            font-size: 1.25rem;
            font-weight: 700;
            margin-bottom: 1rem;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1rem;
            margin-top: 1rem;
            width: 100%;
        }
        .stat-item {
            padding: 1rem;
            background: var(--v2-surface-light);
            border-radius: 8px;
            text-align: center;
            border: 1px solid var(--v2-border);
        }
        .stat-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--v2-text);
        }
        .stat-label {
            font-size: 0.7rem;
            color: var(--v2-text-dim);
            margin-top: 0.25rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .activity-timeline {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        .activity-item {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem;
            background: var(--v2-surface-light);
            border-radius: 10px;
            border-left: 3px solid var(--v2-primary);
            transition: all 0.2s ease;
        }
        .activity-item:hover {
            background: rgba(0, 209, 255, 0.05);
        }
        .activity-date {
            font-size: 0.7rem;
            font-weight: 700;
            color: var(--v2-text-dim);
            min-width: 80px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .activity-type {
            font-weight: 600;
            color: var(--v2-text);
            text-transform: capitalize;
        }
        .activity-count {
            font-size: 0.875rem;
            color: var(--v2-text-dim);
        }
        .critical-list {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }
        .critical-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem;
            background: var(--v2-surface-light);
            border-radius: 8px;
            border-left: 3px solid var(--v2-danger);
            transition: all 0.2s ease;
        }
        .critical-item:hover {
            background: rgba(248, 81, 73, 0.05);
        }
        .critical-ul {
            font-weight: 600;
            color: var(--v2-text);
        }
        .critical-percentage {
            font-weight: 700;
            color: var(--v2-danger);
        }
        .two-column-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1.5rem;
        }
        @media (max-width: 1024px) {
            .two-column-grid {
                grid-template-columns: 1fr;
            }
        }
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(10, 12, 16, 0.95);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            backdrop-filter: blur(10px);
        }
        .loading-spinner {
            width: 60px;
            height: 60px;
            border: 4px solid var(--v2-border);
            border-top-color: var(--v2-primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .loading-text {
            margin-top: 1rem;
            font-size: 1rem;
            font-weight: 600;
            color: var(--v2-text-dim);
        }
    </style>
</head>
<body>
    <div id="loading" class="loading-overlay">
        <div class="loading-spinner"></div>
        <div class="loading-text">Carregando Dashboard...</div>
    </div>

    <div class="v2-container">
        <aside class="v2-sidebar">
            <div class="v2-logo-section">
                <button id="v2-sidebar-toggle" class="v2-sidebar-toggle" type="button">
                    <i data-lucide="panel-left"></i>
                </button>
                <div class="v2-logo-text v2-brand-text">
                    <span class="logo-vigila">Vigila</span>
                    <span class="logo-core">Core</span>
                </div>
            </div>
            <nav class="v2-nav">
                <a href="menu_principal.html" class="v2-nav-item">
                    <i data-lucide="globe"></i>
                    <span class="v2-nav-text">Menu Principal</span>
                </a>
                <a href="dashboard.html" class="v2-nav-item active">
                    <i data-lucide="layout-dashboard"></i>
                    <span class="v2-nav-text">Dashboard</span>
                </a>
                <a href="releitura.html" class="v2-nav-item">
                    <i data-lucide="refresh-cw"></i>
                    <span class="v2-nav-text">Releituras</span>
                </a>
                <a href="porteira.html" class="v2-nav-item">
                    <i data-lucide="door-open"></i>
                    <span class="v2-nav-text">Porteira</span>
                </a>
                <div class="v2-nav-divider"></div>
                <div class="v2-nav-section-label">Em breve</div>
                <a href="relatorios.html" class="v2-nav-item">
                    <i data-lucide="file-text"></i>
                    <span class="v2-nav-text">Relatórios</span>
                </a>
                <a href="ia.html" class="v2-nav-item">
                    <i data-lucide="brain"></i>
                    <span class="v2-nav-text">Análise IA</span>
                </a>
                <a href="usuario.html" class="v2-nav-item">
                    <i data-lucide="circle-user-round"></i>
                    <span class="v2-nav-text">Área do Usuário</span>
                </a>
                <a href="administracao.html" class="v2-nav-item">
                    <i data-lucide="settings"></i>
                    <span class="v2-nav-text">Administração</span>
                </a>
                <a href="login.html" class="v2-nav-item v2-nav-logout">
                    <i data-lucide="power"></i>
                    <span class="v2-nav-text">Sair</span>
                </a>
            </nav>
        </aside>

        <div class="v2-content">
            <header class="v2-header">
                <div class="v2-header-left">
                    <h1 class="v2-header-title">Dashboard Inteligente</h1>
                    <p class="v2-header-subtitle">Visão consolidada | Análise em tempo real</p>
                </div>
                <div class="v2-header-right">
                    <button id="refresh-btn" type="button" class="v2-icon-btn" title="Atualizar">
                        <i data-lucide="refresh-cw"></i>
                    </button>
                    <div id="v2-conn" class="v2-status-pill online">SISTEMA ONLINE</div>
                    <div class="v2-clock-widget">
                        <div class="v2-time-display" id="v2-clock-val">--:--</div>
                        <div class="v2-date-display" id="v2-date">--/--/----</div>
                    </div>
                </div>
            </header>

            <main class="v2-main">
                <div class="dashboard-grid">
                    <div class="metric-card">
                        <div class="metric-header">
                            <span class="metric-title">Releituras Total</span>
                            <div class="metric-icon">
                                <i data-lucide="refresh-cw" style="color: var(--v2-primary); width: 20px; height: 20px;"></i>
                            </div>
                        </div>
                        <div class="metric-value" id="total-releituras">--</div>
                        <div class="metric-label">
                            <span id="releituras-concluidas">--</span> concluídas • 
                            <span id="releituras-pendentes">--</span> pendentes
                        </div>
                    </div>

                    <div class="metric-card">
                        <div class="metric-header">
                            <span class="metric-title">Leituras Executadas</span>
                            <div class="metric-icon" style="background: rgba(35, 134, 54, 0.1); border-color: rgba(35, 134, 54, 0.2);">
                                <i data-lucide="check-circle" style="color: var(--v2-success); width: 20px; height: 20px;"></i>
                            </div>
                        </div>
                        <div class="metric-value" id="leituras-executadas" style="color: var(--v2-success);">--</div>
                        <div class="metric-label">
                            de <span id="total-leituras">--</span> leituras (<span id="leituras-percentual-value">--%</span>)
                        </div>
                    </div>

                    <div class="metric-card">
                        <div class="metric-header">
                            <span class="metric-title">Porteiras</span>
                            <div class="metric-icon" style="background: rgba(210, 153, 34, 0.1); border-color: rgba(210, 153, 34, 0.2);">
                                <i data-lucide="door-open" style="color: var(--v2-warning); width: 20px; height: 20px;"></i>
                            </div>
                        </div>
                        <div class="metric-value" id="total-porteiras" style="color: var(--v2-warning);">--</div>
                        <div class="metric-label">
                            <span id="porteiras-concluidas">--</span> concluídas • 
                            <span id="porteiras-pendentes">--</span> pendentes
                        </div>
                    </div>

                    <div class="metric-card">
                        <div class="metric-header">
                            <span class="metric-title">Uploads</span>
                            <div class="metric-icon">
                                <i data-lucide="cloud-upload" style="color: var(--v2-primary); width: 20px; height: 20px;"></i>
                            </div>
                        </div>
                        <div class="metric-value" id="total-uploads">--</div>
                        <div class="metric-label">Arquivos processados</div>
                    </div>
                </div>

                <div class="two-column-grid">
                    <div class="chart-container">
                        <h3 class="chart-title">Score de Eficiência</h3>
                        <p class="chart-subtitle">Índice de performance operacional</p>
                        <div class="efficiency-score">
                            <div class="score-circle" id="score-circle">
                                <div class="score-value" id="score-value">--</div>
                                <div class="score-label">CALCULANDO</div>
                            </div>
                            <div class="score-classification" id="score-classification">--</div>
                            <div class="stats-grid">
                                <div class="stat-item">
                                    <div class="stat-value" id="score-leituras">--%</div>
                                    <div class="stat-label">Leituras</div>
                                </div>
                                <div class="stat-item">
                                    <div class="stat-value" id="score-releituras">--%</div>
                                    <div class="stat-label">Releituras</div>
                                </div>
                                <div class="stat-item">
                                    <div class="stat-value" id="uls-criticas-count">--</div>
                                    <div class="stat-label">ULs Críticas</div>
                                </div>
                                <div class="stat-item">
                                    <div class="stat-value" id="penalidade-value">--</div>
                                    <div class="stat-label">Penalidade</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="chart-container">
                        <h3 class="chart-title">Atividades Recentes</h3>
                        <p class="chart-subtitle">Últimos 7 dias de operação</p>
                        <div class="activity-timeline" id="activity-timeline">
                            <p style="text-align: center; color: var(--v2-text-dim); padding: 2rem;">Carregando atividades...</p>
                        </div>
                    </div>
                </div>

                <div class="chart-container">
                    <h3 class="chart-title">Tendência de Releituras (30 dias)</h3>
                    <p class="chart-subtitle">Evolução diária de pendentes e realizadas</p>
                    <canvas id="trend-chart" height="80"></canvas>
                </div>

                <div class="two-column-grid">
                    <div class="chart-container">
                        <h3 class="chart-title">Distribuição por Razão</h3>
                        <p class="chart-subtitle">Leituras não executadas na porteira</p>
                        <canvas id="razao-chart" height="250"></canvas>
                    </div>

                    <div class="chart-container">
                        <h3 class="chart-title">ULs Críticas</h3>
                        <p class="chart-subtitle">Maiores percentuais de não execução</p>
                        <div class="critical-list" id="critical-list">
                            <p style="text-align: center; color: var(--v2-text-dim); padding: 2rem;">Carregando dados...</p>
                        </div>
                    </div>
                </div>

                <div class="chart-container">
                    <h3 class="chart-title">Performance por Hora</h3>
                    <p class="chart-subtitle">Média de operações ao longo do dia</p>
                    <canvas id="hourly-chart" height="80"></canvas>
                </div>
            </main>

            <footer class="v2-footer">
                <span>VigilaCore | Dashboard Inteligente v2.0</span>
                <span>Última atualização: <span id="last-update">--:--</span></span>
            </footer>
        </div>
    </div>

    <script>
        let trendChart, razaoChart, hourlyChart;
        
        setInterval(() => {
            const now = new Date();
            document.getElementById('v2-clock-val').innerText = now.toLocaleTimeString('pt-BR', {hour: '2-digit', minute: '2-digit'});
            document.getElementById('v2-date').innerText = now.toLocaleDateString('pt-BR');
        }, 1000);

        async function loadDashboard() {
            try {
                const response = await fetch('/api/dashboard/metrics', {
                    headers: {'Authorization': `Bearer ${localStorage.getItem('auth_token')}`}
                });
                
                if (!response.ok) throw new Error('Erro ao carregar métricas');
                
                const data = await response.json();
                console.log('Dashboard data:', data);
                
                updateMetrics(data);
                document.getElementById('last-update').innerText = new Date().toLocaleTimeString('pt-BR');
                
            } catch (error) {
                console.error('Erro:', error);
            } finally {
                document.getElementById('loading').style.display = 'none';
            }
        }

        function updateMetrics(data) {
            const o = data.overview;
            document.getElementById('total-releituras').innerText = o.total_releituras.toLocaleString('pt-BR');
            document.getElementById('releituras-concluidas').innerText = o.releituras_concluidas.toLocaleString('pt-BR');
            document.getElementById('releituras-pendentes').innerText = o.releituras_pendentes.toLocaleString('pt-BR');
            document.getElementById('total-porteiras').innerText = o.total_porteiras.toLocaleString('pt-BR');
            document.getElementById('porteiras-concluidas').innerText = o.porteiras_concluidas.toLocaleString('pt-BR');
            document.getElementById('porteiras-pendentes').innerText = o.porteiras_pendentes.toLocaleString('pt-BR');
            document.getElementById('total-uploads').innerText = o.total_uploads.toLocaleString('pt-BR');
            
            const p = data.porteira;
            document.getElementById('total-leituras').innerText = p.total_leituras.toLocaleString('pt-BR');
            document.getElementById('leituras-executadas').innerText = p.leituras_executadas.toLocaleString('pt-BR');
            document.getElementById('leituras-percentual-value').innerText = p.percentual_execucao.toFixed(1) + '%';
            
            updateEfficiency(data.porteira_efficiency);
            updateTimeline(data.activity_timeline);
            updateCharts(data);
        }

        function updateEfficiency(e) {
            const circle = document.getElementById('score-circle');
            document.getElementById('score-value').innerText = e.score.toFixed(0);
            document.getElementById('score-classification').innerText = e.classificacao;
            document.getElementById('score-classification').style.color = e.cor;
            
            const percent = e.score / 100;
            circle.style.background = `conic-gradient(${e.cor} ${e.score * 3.6}deg, var(--v2-bg) 0deg)`;
            circle.style.borderColor = e.cor;
            circle.style.boxShadow = `0 0 20px ${e.cor}40`;
            
            const c = e.componentes;
            document.getElementById('score-leituras').innerText = c.score_leituras.toFixed(1) + '%';
            document.getElementById('score-releituras').innerText = c.score_releituras.toFixed(1) + '%';
            document.getElementById('uls-criticas-count').innerText = c.uls_criticas;
            document.getElementById('penalidade-value').innerText = c.penalidade_criticas + 'pts';
        }

        function updateTimeline(timeline) {
            const container = document.getElementById('activity-timeline');
            if (!timeline || timeline.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: var(--v2-text-dim); padding: 2rem;">Nenhuma atividade recente</p>';
                return;
            }
            container.innerHTML = timeline.map(a => `
                <div class="activity-item">
                    <div class="activity-date">${new Date(a.data).toLocaleDateString('pt-BR')}</div>
                    <div style="flex: 1;">
                        <div class="activity-type">${a.tipo}</div>
                        <div class="activity-count">${a.uploads} upload(s) • ${a.registros} registros</div>
                    </div>
                </div>
            `).join('');
        }

        function updateCharts(data) {
            Chart.defaults.color = '#8b949e';
            Chart.defaults.borderColor = '#30363d';
            
            const trend = data.releituras_trend;
            if (trendChart) trendChart.destroy();
            trendChart = new Chart(document.getElementById('trend-chart'), {
                type: 'line',
                data: {
                    labels: trend.map(t => new Date(t.data).toLocaleDateString('pt-BR', {day: '2-digit', month: '2-digit'})),
                    datasets: [{
                        label: 'Realizadas',
                        data: trend.map(t => t.media_realizadas),
                        borderColor: '#238636',
                        backgroundColor: 'rgba(35, 134, 54, 0.1)',
                        tension: 0.4,
                        fill: true
                    }, {
                        label: 'Pendentes',
                        data: trend.map(t => t.media_pendentes),
                        borderColor: '#f85149',
                        backgroundColor: 'rgba(248, 81, 73, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: { display: true, position: 'top' }
                    }
                }
            });

            const dist = data.porteira.distribuicao_razao;
            if (razaoChart) razaoChart.destroy();
            if (dist && dist.length > 0) {
                razaoChart = new Chart(document.getElementById('razao-chart'), {
                    type: 'doughnut',
                    data: {
                        labels: dist.map(d => `Razão ${d.razao}`),
                        datasets: [{
                            data: dist.map(d => d.nao_executadas),
                            backgroundColor: ['#00d1ff', '#238636', '#d29922', '#f85149', '#8b5cf6', '#ec4899', '#6366f1']
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        plugins: {
                            legend: { display: true, position: 'right' }
                        }
                    }
                });
            }

            const criticas = data.porteira.uls_criticas;
            const critList = document.getElementById('critical-list');
            if (!criticas || criticas.length === 0) {
                critList.innerHTML = '<p style="text-align: center; color: var(--v2-text-dim); padding: 2rem;">Nenhuma UL crítica identificada</p>';
            } else {
                critList.innerHTML = criticas.slice(0, 10).map(u => `
                    <div class="critical-item">
                        <div>
                            <div class="critical-ul">UL ${u.ul}</div>
                            <div style="font-size: 0.7rem; color: var(--v2-text-dim); text-transform: uppercase; letter-spacing: 0.5px;">Razão ${u.razao}</div>
                        </div>
                        <div class="critical-percentage">${u.percentual.toFixed(1)}%</div>
                    </div>
                `).join('');
            }

            const hourly = data.performance_hourly;
            const hours = Object.keys(hourly).sort();
            if (hourlyChart) hourlyChart.destroy();
            if (hours.length > 0) {
                hourlyChart = new Chart(document.getElementById('hourly-chart'), {
                    type: 'bar',
                    data: {
                        labels: hours,
                        datasets: [{
                            label: 'Média Total',
                            data: hours.map(h => hourly[h].media_total),
                            backgroundColor: 'rgba(0, 209, 255, 0.6)'
                        }, {
                            label: 'Média Realizadas',
                            data: hours.map(h => hourly[h].media_realizadas),
                            backgroundColor: 'rgba(35, 134, 54, 0.6)'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        plugins: {
                            legend: { display: true, position: 'top' }
                        }
                    }
                });
            }
        }

        document.getElementById('refresh-btn').addEventListener('click', () => {
            document.getElementById('loading').style.display = 'flex';
            loadDashboard();
        });

        document.addEventListener('DOMContentLoaded', () => {
            lucide.createIcons();
            loadDashboard();
        });

        setInterval(loadDashboard, 5 * 60 * 1000);
    </script>
</body>
</html>
